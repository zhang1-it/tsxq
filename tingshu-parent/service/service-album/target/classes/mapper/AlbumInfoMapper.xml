<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >


<mapper namespace="com.atguigu.tingshu.album.mapper.AlbumInfoMapper">


    <select id="selectUserAlbumPage" resultType="com.atguigu.tingshu.vo.album.AlbumListVo">
        select ai.id as albumId,
               ai.album_title,
               ai.cover_url,
               ai.include_track_count,
               ai.is_finished,
               ai.status,
               max(if(ast.stat_type = 0401, ast.stat_num, 0)) playStatNum,
               max(if(ast.stat_type = 0402, ast.stat_num, 0)) subscribeStatNum,
               max(if(ast.stat_type = 0403, ast.stat_num, 0)) buyStatNum,
               max(if(ast.stat_type = 0404, ast.stat_num, 0)) commentStatNum
        from album_info ai
                 inner join album_stat ast
                            on ai.id = ast.album_id
        <where>
            ai.user_id = #{query.userId}
        <if test="query.status != null and query.status!=''">
            and ai.status = query.status
        </if>
            <if test="query.albumTitle != null and query.albumTitle!=''">
                and ai.album_title like CONCAT('%', query.albumTitle, '%')
            </if>
            and ai.is_deleted = 0
            and ast.is_deleted = 0
        </where>
        group by ai.id
        order by ai.id desc
    </select>
</mapper>

